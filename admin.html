<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AS Earn Hub Admin Panel</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* Embedded CSS for Admin Panel (Futuristic, Minimal UI) */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

        :root {
            --admin-bg-dark: #12082b;
            --admin-bg-light: #1e0c4a;
            --admin-primary: #00e5ff; /* Electric Teal */
            --admin-secondary: #7f00ff; /* Neon Purple */
            --admin-accent: #ff007f; /* Hot Pink */
            --admin-text: #e0e0e0;
            --admin-card-bg: rgba(255, 255, 255, 0.05);
            --admin-card-border: rgba(255, 255, 255, 0.1);
            --admin-input-bg: rgba(255, 255, 255, 0.02);
            --border-radius: 8px;
            --button-radius: 5px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--admin-bg-dark), var(--admin-bg-light));
            color: var(--admin-text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #admin-app {
            width: 100%;
            max-width: 900px;
            padding: 20px;
            box-sizing: border-box;
        }

        h1, h2, h3 {
            color: var(--admin-primary);
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }

        .admin-card {
            background: var(--admin-card-bg);
            border: 1px solid var(--admin-card-border);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .auth-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
        }

        .auth-card {
            width: 100%;
            max-width: 350px;
            text-align: center;
        }

        input[type="text"],
        input[type="password"],
        input[type="email"],
        textarea,
        select {
            width: calc(100% - 22px); /* Account for padding + border */
            padding: 10px;
            margin: 10px 0;
            border: 1px solid var(--admin-card-border);
            border-radius: var(--button-radius);
            background: var(--admin-input-bg);
            color: var(--admin-text);
            font-size: 1em;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="email"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--admin-primary);
            box-shadow: 0 0 8px var(--admin-primary);
        }

        .admin-button {
            background: linear-gradient(90deg, var(--admin-secondary), var(--admin-primary));
            color: white;
            border: none;
            border-radius: var(--button-radius);
            padding: 10px 20px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            margin-top: 10px;
            margin-right: 10px;
        }

        .admin-button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .admin-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.4);
        }

        .admin-button.danger {
            background: linear-gradient(90deg, #dc3545, #c82333);
        }
        .admin-button.success {
            background: linear-gradient(90deg, #28a745, #218838);
        }
        .admin-button.info {
            background: linear-gradient(90deg, #17a2b8, #138496);
        }
        .admin-button:disabled {
            background: #444;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Withdrawal Table */
        .withdrawal-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .withdrawal-table th, .withdrawal-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            font-size: 0.9em;
        }

        .withdrawal-table th {
            color: var(--admin-primary);
            background-color: rgba(255, 255, 255, 0.02);
            font-weight: 500;
        }

        .withdrawal-table tr:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .withdrawal-status {
            font-weight: bold;
        }

        .status-PENDING { color: orange; }
        .status-SUCCESSFUL { color: #28a745; }
        .status-REJECTED { color: #dc3545; }

        .withdrawal-actions button {
            margin-right: 5px;
            padding: 6px 10px;
            font-size: 0.8em;
        }

        /* Modals */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--admin-bg-dark);
            margin: auto;
            padding: 30px;
            border: 1px solid var(--admin-primary);
            border-radius: var(--border-radius);
            width: 80%;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        .close-button {
            color: var(--admin-text);
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--admin-primary);
            text-decoration: none;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Loader */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--admin-primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-message {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 229, 255, 0.1);
            border-left: 4px solid var(--admin-primary);
            border-radius: 4px;
            font-size: 0.9em;
        }

        .error-message {
             margin-top: 10px;
             padding: 10px;
             background: rgba(220, 53, 69, 0.1);
             border-left: 4px solid #dc3545;
             border-radius: 4px;
             color: #dc3545;
             font-size: 0.9em;
        }

        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        }

        .toast {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 12px 18px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            opacity: 0;
            animation: slideInRight 0.4s ease-out forwards, fadeOut 0.5s 2.5s ease-in forwards;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.success { background: linear-gradient(90deg, #28a745, #218838); }
        .toast.error { background: linear-gradient(90deg, #dc3545, #c82333); }
        .toast.info { background: linear-gradient(90deg, #17a2b8, #138496); }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

    </style>
</head>
<body>
    <div id="admin-app">
        <div id="auth-screen" class="auth-section">
            <div class="admin-card auth-card">
                <h2>Admin Login</h2>
                <input type="password" id="adminPassword" placeholder="Enter Admin Password">
                <button class="admin-button" id="loginButton">Login</button>
                <p id="loginError" class="error-message" style="display: none;">Invalid password.</p>
                <p class="info-message">
                    <strong>WARNING:</strong> This admin panel uses a client-side password for demonstration ONLY.
                    For production, use Firebase Authentication and secure server-side logic (e.g., Cloud Functions).
                </p>
            </div>
        </div>

        <div id="dashboard-screen" style="display: none;">
            <h1>AS Earn Hub Admin Dashboard</h1>

            <!-- Broadcast Messages -->
            <div class="admin-card">
                <h2>Broadcast Message</h2>
                <textarea id="broadcastMessage" rows="4" placeholder="Enter message to broadcast to all users..."></textarea>
                <button class="admin-button" id="sendBroadcast">Send Broadcast</button>
            </div>

            <!-- Withdrawal Management -->
            <div class="admin-card">
                <h2>Withdrawal Management</h2>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="filterUserId" placeholder="Filter by User ID" style="flex: 1 1 150px;">
                    <input type="text" id="filterUsername" placeholder="Filter by Username" style="flex: 1 1 150px;">
                    <select id="filterStatus" style="flex: 1 1 100px;">
                        <option value="">All Statuses</option>
                        <option value="PENDING">Pending</option>
                        <option value="SUCCESSFUL">Successful</option>
                        <option value="REJECTED">Rejected</option>
                    </select>
                    <button class="admin-button info" id="applyFilterButton" style="flex: 1 1 auto; margin-right: 0;">Apply Filter</button>
                    <button class="admin-button" id="clearFilterButton" style="flex: 1 1 auto; margin-right: 0;">Clear Filter</button>
                </div>

                <div style="overflow-x: auto;">
                    <table class="withdrawal-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>User</th>
                                <th>Points</th>
                                <th>Method</th>
                                <th>Recipient</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalTableBody">
                            <tr><td colspan="7" style="text-align: center;">Loading withdrawals...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- User Search/Adjustment (Simplified) -->
            <div class="admin-card">
                <h2>User Lookup & Adjustment (Simplified)</h2>
                <input type="text" id="searchUserQuery" placeholder="Search by User ID or Username">
                <button class="admin-button" id="searchUserButton">Search User</button>
                <div id="userResult" style="margin-top: 15px;">
                    <!-- User details will be displayed here -->
                </div>
            </div>

            <!-- Modal for Withdrawal Actions -->
            <div id="withdrawalModal" class="modal">
                <div class="modal-content">
                    <span class="close-button" id="closeModalButton">&times;</span>
                    <h3>Update Withdrawal Status</h3>
                    <p><strong>Withdrawal ID:</strong> <span id="modalWithdrawalId"></span></p>
                    <p><strong>User:</strong> <span id="modalWithdrawalUser"></span></p>
                    <p><strong>Amount:</strong> <span id="modalWithdrawalAmount"></span> AS Points</p>
                    <p><strong>Method:</strong> <span id="modalWithdrawalMethod"></span></p>
                    <p><strong>Current Status:</strong> <span id="modalCurrentStatus" class="withdrawal-status"></span></p>

                    <label for="adminNote">Admin Note (optional):</label>
                    <textarea id="adminNote" rows="3" placeholder="Enter a reason or note..."></textarea>

                    <button class="admin-button success" id="modalMarkSuccessful">✅ Mark Successful</button>
                    <button class="admin-button danger" id="modalMarkRejected">❌ Mark Rejected</button>
                    <button class="admin-button info" id="modalMarkPending">⏳ Mark Pending</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container for Admin Panel -->
    <div id="toast-container"></div>

    <script>
        // Embed Firebase Config (replace with your actual config)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "YOUR_MEASUREMENT_ID" // Optional
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- Admin Panel Specific Global Variables & Constants ---
        const ADMIN_PASSWORD = 'admin_password_123'; // *** VERY INSECURE: REPLACE OR USE FIREBASE AUTH ***
        const TELEGRAM_CHANNEL_FOR_WITHDRAWALS = '1002991582791'; // Ensure this is correct
        let currentWithdrawalId = null;
        let withdrawalListener = null; // To manage the real-time listener

        // --- Utility Functions (replicated for self-contained admin.html) ---
        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            let icon = '';
            if (type === 'success') icon = '✅';
            else if (type === 'error') icon = '❌';
            else icon = 'ℹ️';

            toast.innerHTML = `<span class="toast-icon">${icon}</span> ${message}`;
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration - 500);

            setTimeout(() => {
                if (toast.parentElement) toast.remove();
            }, duration);
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate();
            return date.toLocaleString(undefined, {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        // --- Admin Panel Functions ---

        /**
         * Renders the withdrawal table with real-time updates and filtering.
         */
        function setupWithdrawalListener() {
            if (withdrawalListener) {
                withdrawalListener(); // Detach previous listener if exists
            }

            const tableBody = document.getElementById('withdrawalTableBody');
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;"><div class="loader"></div> Loading withdrawals...</td></tr>';

            let query = db.collection('withdrawals').orderBy('created_at', 'desc');

            const filterUserId = document.getElementById('filterUserId').value.trim();
            const filterUsername = document.getElementById('filterUsername').value.trim().toLowerCase();
            const filterStatus = document.getElementById('filterStatus').value;

            if (filterUserId) {
                query = query.where('user_id', '==', filterUserId);
            }
            if (filterStatus) {
                query = query.where('status', '==', filterStatus);
            }
            // Filtering by username is tricky as it's not a direct '==' query field for partial matches
            // We'll fetch all and filter client-side if username filter is active
            
            withdrawalListener = query.onSnapshot(async (snapshot) => {
                let withdrawals = [];
                for (const doc of snapshot.docs) {
                    const withdrawal = doc.data();
                    withdrawal.id = doc.id;
                    withdrawals.push(withdrawal);
                }

                if (filterUsername) {
                    withdrawals = withdrawals.filter(w => 
                        (w.telegram_username && w.telegram_username.toLowerCase().includes(filterUsername)) ||
                        (w.telegram_profile_name && w.telegram_profile_name.toLowerCase().includes(filterUsername))
                    );
                }

                tableBody.innerHTML = ''; // Clear existing rows

                if (withdrawals.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No withdrawals found.</td></tr>';
                    return;
                }

                for (const withdrawal of withdrawals) {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${formatDateTime(withdrawal.created_at)}</td>
                        <td>
                            <strong>${withdrawal.telegram_profile_name || 'N/A'}</strong><br>
                            @${withdrawal.telegram_username || 'N/A'}<br>
                            ID: ${withdrawal.user_id}
                        </td>
                        <td>${withdrawal.amount_as_points} AS</td>
                        <td>${withdrawal.method === 'BINANCE' ? 'Binance Pay' : 'Google Play'}</td>
                        <td>${withdrawal.recipient}</td>
                        <td class="withdrawal-status status-${withdrawal.status}">${withdrawal.status}</td>
                        <td class="withdrawal-actions">
                            <button class="admin-button info" onclick="openWithdrawalModal('${withdrawal.id}')">Review</button>
                        </td>
                    `;
                }
            }, (error) => {
                console.error("Error fetching withdrawals:", error);
                showToast("Error loading withdrawals.", "error");
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Error loading withdrawals.</td></tr>';
            });
        }

        /**
         * Opens the withdrawal modal for a specific withdrawal.
         * @param {string} id The ID of the withdrawal document.
         */
        async function openWithdrawalModal(id) {
            currentWithdrawalId = id;
            const withdrawalDoc = await db.collection('withdrawals').doc(id).get();
            if (!withdrawalDoc.exists) {
                showToast("Withdrawal not found.", "error");
                return;
            }
            const withdrawal = withdrawalDoc.data();

            document.getElementById('modalWithdrawalId').textContent = id;
            document.getElementById('modalWithdrawalUser').textContent = `${withdrawal.telegram_profile_name} (@${withdrawal.telegram_username || 'N/A'}) - ID: ${withdrawal.user_id}`;
            document.getElementById('modalWithdrawalAmount').textContent = withdrawal.amount_as_points;
            document.getElementById('modalWithdrawalMethod').textContent = withdrawal.method === 'BINANCE' ? 'Binance Pay ID' : 'Google Play Redeem Code';
            document.getElementById('modalCurrentStatus').textContent = withdrawal.status;
            document.getElementById('modalCurrentStatus').className = `withdrawal-status status-${withdrawal.status}`;
            document.getElementById('adminNote').value = withdrawal.admin_note || '';

            document.getElementById('withdrawalModal').style.display = 'flex';
        }

        /**
         * Closes the withdrawal modal.
         */
        function closeWithdrawalModal() {
            document.getElementById('withdrawalModal').style.display = 'none';
            currentWithdrawalId = null;
        }

        /**
         * Updates the status of a withdrawal request.
         * @param {'SUCCESSFUL'|'REJECTED'|'PENDING'} status The new status.
         */
        async function updateWithdrawalStatus(status) {
            if (!currentWithdrawalId) return;

            const adminNote = document.getElementById('adminNote').value.trim();
            if (status === 'REJECTED' && !adminNote) {
                showToast("Please provide a reason for rejection.", "error");
                return;
            }

            try {
                const withdrawalRef = db.collection('withdrawals').doc(currentWithdrawalId);
                const withdrawalDocBefore = await withdrawalRef.get();
                if (!withdrawalDocBefore.exists) throw new Error("Withdrawal not found during update.");
                const withdrawalDataBefore = withdrawalDocBefore.data();

                await withdrawalRef.update({
                    status: status,
                    admin_note: adminNote,
                    updated_at: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Log admin action (for auditability)
                await db.collection('admin_logs').add({
                    admin_id: 'AdminUser', // Replace with actual admin user if using Firebase Auth
                    action_type: 'WITHDRAWAL_UPDATE',
                    target_withdrawal_id: currentWithdrawalId,
                    target_user_id: withdrawalDataBefore.user_id,
                    status_before: withdrawalDataBefore.status,
                    status_after: status,
                    admin_note: adminNote,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast(`Withdrawal ${currentWithdrawalId} marked as ${status}.`, 'success');
                closeWithdrawalModal();

                // --- Simulate Bot Notification to user ---
                const userNotificationMessage = `👋 Hello ${withdrawalDataBefore.telegram_profile_name || 'user'}!

Your withdrawal request for ${withdrawalDataBefore.amount_as_points} AS Points via ${withdrawalDataBefore.method === 'BINANCE' ? 'Binance Pay' : 'Google Play Redeem Code'} has been updated:

⏳ Old Status: ${withdrawalDataBefore.status === 'PENDING' ? '🔴 Pending' : withdrawalDataBefore.status === 'SUCCESSFUL' ? '✅ Successful' : '❌ Rejected'}
✨ New Status: ${status === 'PENDING' ? '🔴 Pending (Under Review)' : status === 'SUCCESSFUL' ? '✅ Successful' : '❌ Rejected'}

Recipient: ${withdrawalDataBefore.recipient}
${adminNote ? `Admin Note: ${adminNote}\n` : ''}

${status === 'SUCCESSFUL' ? 'Your payment has been processed! Please check your account/email shortly.' :
   status === 'REJECTED' ? 'Unfortunately, your request was rejected. Please review the admin note.' :
   'Your request is still under review.'}

Thank you for using AS Earn Hub!
`;
                console.log(`[Bot Simulation]: Sending withdrawal status update to user ${withdrawalDataBefore.user_id}:\n${userNotificationMessage}`);
                // In a real app, send this to your bot's API endpoint to deliver to the user.

            } catch (error) {
                console.error("Error updating withdrawal status:", error);
                showToast("Failed to update withdrawal status.", "error");
            }
        }

        /**
         * Sends a broadcast message to all users.
         */
        document.getElementById('sendBroadcast').addEventListener('click', async () => {
            const message = document.getElementById('broadcastMessage').value.trim();
            if (!message) {
                showToast("Please enter a message to broadcast.", "error");
                return;
            }

            if (!confirm("Are you sure you want to broadcast this message to ALL users?")) {
                return;
            }

            try {
                await db.collection('broadcasts').add({
                    message: message,
                    admin_id: 'AdminUser', // Placeholder
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Log admin action
                await db.collection('admin_logs').add({
                    admin_id: 'AdminUser',
                    action_type: 'BROADCAST_MESSAGE',
                    details: { message: message },
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                document.getElementById('broadcastMessage').value = '';
                showToast("Broadcast message sent (simulated).", "success");

                // --- Simulate Bot Notification to all users ---
                console.log(`[Bot Simulation]: Broadcasting message to all users:\n\n"${message}"\n\n(This would require a Cloud Function or dedicated bot backend to send to all Telegram users.)`);
                // --- End Bot Simulation ---

            } catch (error) {
                console.error("Error sending broadcast:", error);
                showToast("Failed to send broadcast message.", "error");
            }
        });

        /**
         * Handles user search and displays basic info.
         */
        document.getElementById('searchUserButton').addEventListener('click', async () => {
            const query = document.getElementById('searchUserQuery').value.trim();
            const userResultDiv = document.getElementById('userResult');
            userResultDiv.innerHTML = '<div class="loader"></div> Searching...';

            if (!query) {
                userResultDiv.innerHTML = '<p class="error-message">Please enter a User ID or Username.</p>';
                return;
            }

            try {
                let userDocData = null;
                let userDocId = null;

                // 1. Try searching by exact user ID
                let snapshotById = await db.collection('users').doc(query).get();
                if (snapshotById.exists) {
                    userDocData = snapshotById.data();
                    userDocId = snapshotById.id;
                } else {
                    // 2. Try searching by exact username (case-insensitive not directly supported without a custom field/index)
                    let snapshotByUsername = await db.collection('users').where('telegram_username', '==', query).limit(1).get();
                    if (!snapshotByUsername.empty) {
                        userDocData = snapshotByUsername.docs[0].data();
                        userDocId = snapshotByUsername.docs[0].id;
                    } else {
                        // 3. Try searching by exact profile name
                        let snapshotByProfileName = await db.collection('users').where('telegram_profile_name', '==', query).limit(1).get();
                        if (!snapshotByProfileName.empty) {
                            userDocData = snapshotByProfileName.docs[0].data();
                            userDocId = snapshotByProfileName.docs[0].id;
                        }
                    }
                }
                
                if (userDocData) {
                    userResultDiv.innerHTML = `
                        <div class="admin-card">
                            <h3>User: ${userDocData.telegram_profile_name || userDocData.telegram_username}</h3>
                            <p><strong>User ID:</strong> ${userDocId}</p>
                            <p><strong>Username:</strong> @${userDocData.telegram_username || 'N/A'}</p>
                            <p><strong>Current Balance:</strong> ${userDocData.current_balance_as} AS</p>
                            <p><strong>Total Earned:</strong> ${userDocData.total_earned_as} AS</p>
                            <p><strong>Total Tasks:</strong> ${userDocData.total_tasks_completed} </p>
                            <p><strong>Referrals:</strong> ${userDocData.referrals_count} </p>
                            <p><strong>Referred By:</strong> ${userDocData.referred_by || 'N/A'}</p>
                            <p><strong>Join Date:</strong> ${formatDateTime(userDocData.joined_at)}</p>
                            <p><strong>Last Seen:</strong> ${formatDateTime(userDocData.last_seen_at)}</p>
                            <!-- Add more fields and potentially edit buttons here -->
                        </div>
                    `;
                    showToast("User found!", "success");
                } else {
                    userResultDiv.innerHTML = '<p class="info-message">No user found with that ID or Username.</p>';
                    showToast("User not found.", "info");
                }
            } catch (error) {
                console.error("Error searching user:", error);
                userResultDiv.innerHTML = '<p class="error-message">Error searching user.</p>';
                showToast("Error searching user.", "error");
            }
        });


        // --- Event Listeners for Withdrawal Modal ---
        document.getElementById('closeModalButton').addEventListener('click', closeWithdrawalModal);
        document.getElementById('modalMarkSuccessful').addEventListener('click', () => updateWithdrawalStatus('SUCCESSFUL'));
        document.getElementById('modalMarkRejected').addEventListener('click', () => updateWithdrawalStatus('REJECTED'));
        document.getElementById('modalMarkPending').addEventListener('click', () => updateWithdrawalStatus('PENDING'));
        window.addEventListener('click', (event) => {
            if (event.target === document.getElementById('withdrawalModal')) {
                closeWithdrawalModal();
            }
        });

        // --- Event Listeners for Withdrawal Filters ---
        document.getElementById('applyFilterButton').addEventListener('click', setupWithdrawalListener);
        document.getElementById('clearFilterButton').addEventListener('click', () => {
            document.getElementById('filterUserId').value = '';
            document.getElementById('filterUsername').value = '';
            document.getElementById('filterStatus').value = '';
            setupWithdrawalListener();
        });


        // --- Authentication Logic (VERY INSECURE CLIENT-SIDE DEMO) ---
        document.getElementById('loginButton').addEventListener('click', () => {
            const password = document.getElementById('adminPassword').value;
            const loginError = document.getElementById('loginError');
            if (password === ADMIN_PASSWORD) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('dashboard-screen').style.display = 'block';
                showToast("Admin login successful!", "success");
                setupWithdrawalListener(); // Start listening for withdrawals
            } else {
                loginError.style.display = 'block';
                showToast("Invalid admin password.", "error");
            }
        });

        // Initial check for authentication screen
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('dashboard-screen').style.display = 'none';
        });

    </script>
</body>
</html>